<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>国旗大戦（SOLO）</title>
  <style>
    :root{
      --bg:#000;
      --uiText:#fff;
      --uiDim:rgba(255,255,255,.22);
      --chip:rgba(255,255,255,.14);
      --card:#ffffff;
      --card2:#f3f3f3;
      --shadow: 0 16px 40px rgba(0,0,0,.55);
      --radius:24px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Segoe UI", sans-serif;
      background: radial-gradient(1200px 700px at 50% -10%, #222, #000 55%, #000);
      color:var(--uiText);
      overflow-x:hidden;
    }

    /* ===== Top Menu (outside) ===== */
    .topbar{
      position: fixed;
      top: env(safe-area-inset-top);
      left:0;
      right:0;
      z-index: 1000;
      padding: 10px 12px 10px;
      display:flex;
      gap:10px;
      justify-content:center;
      pointer-events:auto;
    }
    .pill{
      min-width: 110px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 10px 24px rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      user-select:none;
    }
    .pill .label{
      opacity:.7;
      letter-spacing:.18em;
      font-weight:700;
      font-size:12px;
    }
    .pill .value{
      font-weight:900;
      font-size:20px;
      letter-spacing:.04em;
    }
    .btn{
      cursor:pointer;
      border:none;
      color:#fff;
      font-weight:900;
      letter-spacing:.12em;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.16);
    }
    .btn:active{ transform: translateY(1px); }

    /* ===== Layout ===== */
    .wrap{
      padding-top: calc(env(safe-area-inset-top) + 74px); /* topbar space */
      padding-bottom: calc(env(safe-area-inset-bottom) + 14px);
      width: min(520px, 100%);
      margin: 0 auto;
    }

    /* ===== Scene Card ===== */
    .scene{
      position: relative;
      margin: 10px 14px 12px;
      border-radius: 28px;
      overflow:hidden;
      box-shadow: var(--shadow);
      background: #111;
      /* 画面上は女の子＋UI、下は選択肢なので高さは控えめに */
      height: min(58vh, 560px);
      min-height: 420px;
    }

    /* 女の子背景は常に最背面 */
    .scene::before{
      content:"";
      position:absolute;
      inset:0;
      background-image: url("assets/chi_base.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: saturate(1.02);
      z-index: 0;
      transform: translateZ(0);
    }

    /* うっすら暗幕（必要なら薄く） */
    .scene::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(900px 420px at 50% 30%, rgba(0,0,0,0), rgba(0,0,0,.28));
      z-index: 1;
    }

    .layer{
      position:absolute;
      inset:0;
      z-index: 2; /* 背景より前 */
      display:flex;
      flex-direction:column;
      padding: 18px 16px 16px;
      gap: 14px;
    }

    /* ===== Speech bubble ===== */
    .speech{
      position: relative;
      width: 100%;
      padding: 18px 18px;
      border-radius: 26px;
      background: rgba(255,255,255,.90);
      color:#111;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      font-weight: 900;
      font-size: 34px;
      letter-spacing: .02em;
      line-height: 1.1;
    }
    .speech:before{
      content:"";
      position:absolute;
      left: 38px;
      bottom: -14px;
      width: 0;
      height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-top: 14px solid rgba(255,255,255,.90);
      filter: drop-shadow(0 8px 10px rgba(0,0,0,.18));
    }
    .stageBadge{
      position:absolute;
      right: 16px;
      top: 16px;
      padding: 12px 16px;
      border-radius: 999px;
      background: rgba(0,0,0,.28);
      color:#fff;
      font-weight: 900;
      letter-spacing: .18em;
      font-size: 18px;
      border: 1px solid rgba(255,255,255,.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* ===== Paper / Flag area ===== */
    .paper{
      margin-top: auto; /* 下寄せ */
      width: 100%;
      height: 56%;
      border-radius: 30px;
      background: rgba(255,255,255,.82);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .paperInner{
      width: 100%;
      height: 100%;
      border-radius: 22px;
      background: rgba(255,255,255,.70);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
      overflow:hidden;
    }

    /* 旗の見せ方：
       - 基本は contain（はみ出さない）
       - 画像に余白がある場合に「小さく見える」ので、JSで scale を少し足す */
    .flagImg{
      width: 100%;
      height: 100%;
      object-fit: contain;
      transform-origin: center center;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.12));
      border-radius: 10px;
      background: transparent;
    }

    /* ===== Answers ===== */
    .answers{
      margin: 0 14px 18px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .ansBtn{
      height: 74px;            /* 高さを抑えめ */
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.72);
      color:#fff;
      font-weight: 900;
      font-size: 28px;
      letter-spacing: .08em;
      box-shadow: 0 14px 26px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor:pointer;
      transition: transform .06s ease, filter .2s ease;
      user-select:none;
    }
    .ansBtn:active{ transform: translateY(1px) scale(.99); }
    .ansBtn.correct{ filter: brightness(1.15); }
    .ansBtn.wrong{ filter: brightness(.85); opacity:.9; }

    /* small screens */
    @media (max-width: 390px){
      .speech{ font-size: 30px; }
      .ansBtn{ font-size: 24px; height: 70px; }
      .scene{ min-height: 400px; }
    }
  </style>
</head>

<body>
  <!-- Top Menu -->
  <div class="topbar">
    <div class="pill" aria-label="mode">
      <div class="label">MODE</div>
      <div class="value" id="modeText">SOLO</div>
    </div>

    <div class="pill" aria-label="time">
      <div class="label">TIME</div>
      <div class="value"><span id="timeText">0.0</span><span style="font-size:14px;opacity:.85;margin-left:6px;">s</span></div>
    </div>

    <button class="pill btn" id="retryBtn" type="button">RETRY</button>
  </div>

  <div class="wrap">
    <!-- Scene -->
    <div class="scene" id="scene">
      <div class="layer">
        <div class="speech">
          <span id="questionText">どこだと思う？</span>
          <div class="stageBadge" id="stageText">STAGE 1</div>
        </div>

        <div class="paper">
          <div class="paperInner">
            <img id="flagImg" class="flagImg" alt="flag" />
          </div>
        </div>
      </div>
    </div>

    <!-- Answers -->
    <div class="answers" id="answers"></div>
  </div>

  <script>
    // =========================
    // 画像ファイル設定（必要に応じて増やしてOK）
    // scale は「元画像に余白があると小さく見える」対策
    // =========================
    const FLAGS = [
      { id:"jp", name:"日本",         file:"assets/flags/jp.png", scale:1.10 },
      { id:"us", name:"アメリカ",     file:"assets/flags/us.png", scale:1.12 },
      { id:"fr", name:"フランス",     file:"assets/flags/fr.png", scale:1.14 },
      { id:"br", name:"ブラジル",     file:"assets/flags/br.png", scale:1.16 },
      { id:"au", name:"オーストラリア", file:"assets/flags/au.png", scale:1.12 },
      // 追加例：
      // { id:"cn", name:"中国", file:"assets/flags/cn.png", scale:1.12 },
    ];

    const questionText = document.getElementById("questionText");
    const stageText = document.getElementById("stageText");
    const timeText = document.getElementById("timeText");
    const flagImg = document.getElementById("flagImg");
    const answersEl = document.getElementById("answers");
    const retryBtn = document.getElementById("retryBtn");

    let stage = 1;
    let current = null;
    let startAt = null;
    let rafId = null;
    let locked = false;

    function pickRandom(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
    function shuffle(a){
      const b = a.slice();
      for(let i=b.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [b[i], b[j]] = [b[j], b[i]];
      }
      return b;
    }

    function startTimer(){
      startAt = performance.now();
      if(rafId) cancelAnimationFrame(rafId);
      const tick = () => {
        const t = (performance.now() - startAt) / 1000;
        timeText.textContent = t.toFixed(1);
        rafId = requestAnimationFrame(tick);
      };
      tick();
    }

    function buildChoices(correct){
      const pool = FLAGS.filter(x => x.id !== correct.id);
      const picks = shuffle(pool).slice(0,3);
      return shuffle([correct, ...picks]);
    }

    function renderStage(){
      locked = false;
      stageText.textContent = `STAGE ${stage}`;
      questionText.textContent = "どこだと思う？";

      current = pickRandom(FLAGS);

      // 旗表示
      flagImg.src = current.file;
      flagImg.style.transform = `scale(${current.scale || 1.12})`;

      // 選択肢
      const choices = buildChoices(current);
      answersEl.innerHTML = "";
      choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.className = "ansBtn";
        btn.type = "button";
        btn.textContent = choice.name;
        btn.addEventListener("click", () => onAnswer(btn, choice));
        answersEl.appendChild(btn);
      });

      startTimer();
    }

    function onAnswer(btn, choice){
      if(locked) return;
      locked = true;

      const buttons = [...document.querySelectorAll(".ansBtn")];
      const correct = choice.id === current.id;

      buttons.forEach(b => b.disabled = true);

      if(correct){
        btn.classList.add("correct");
        // 少し気持ちよくテンポ良く次へ
        setTimeout(() => {
          stage++;
          renderStage();
        }, 220);
      }else{
        btn.classList.add("wrong");
        // 正解を軽く光らせる（叱らない）
        const correctBtn = buttons.find(b => b.textContent === current.name);
        if(correctBtn) correctBtn.classList.add("correct");
        setTimeout(() => {
          stage = 1;
          renderStage();
        }, 520);
      }
    }

    function retry(){
      stage = 1;
      renderStage();
    }

    retryBtn.addEventListener("click", retry);

    // 画像が見つからないときに気づけるように（デバッグ用）
    flagImg.addEventListener("error", () => {
      // 旗画像が404だと、白紙っぽく見えるので分かりやすくする
      flagImg.removeAttribute("src");
      flagImg.style.transform = "scale(1)";
      flagImg.alt = "旗画像が見つかりません";
    });

    // 初回
    renderStage();
  </script>
</body>
</html>
