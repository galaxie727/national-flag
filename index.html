<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>国旗大戦（仮）</title>
  <style>
    :root{
      /* ===== 旗（紙）の位置・サイズ（最終調整はここだけ） ===== */
      --fx: 8%;
      --fy: 52%;
      --fw: 84%;
      --fh: 30%;
      --fp: 6%;

      /* 旗画像の「見た目トリム」（object-fit:cover の拡大率・位置） */
      --flag-zoom: 1.12; /* 大きいほど余白が消える */
      --flag-ox: 50%;
      --flag-oy: 50%;

      /* 全体トーン */
      --bg: #0b0b0c;
      --panel: rgba(0,0,0,.45);
      --panel2: rgba(0,0,0,.55);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --stroke: rgba(255,255,255,.10);
      --shadow: 0 16px 40px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,sans-serif;}
    button{font:inherit}

    /* ===== 画面 ===== */
    .app{
      position:relative;
      height:100vh;
      height:100dvh;
      width:100%;
      overflow:hidden;
      background:#000;
    }

    /* 女の子背景（画面いっぱい） */
    .bg{
      position:absolute; inset:0;
      background:url("chi_base.png") center/cover no-repeat;
      filter:saturate(1.02);
      transform:scale(1.01);
    }

    /* 上部の暗いグラデ（メニュー読みやすく） */
    .topFade{
      position:absolute;
      left:0; right:0;
      top:0;
      height:140px;
      background:linear-gradient(to bottom, rgba(0,0,0,.58), rgba(0,0,0,.18), rgba(0,0,0,0));
      pointer-events:none;
    }

    /* ===== 上部メニュー ===== */
    .topMenu{
      position:absolute;
      top: env(safe-area-inset-top);
      left:0; right:0;
      padding: 10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      z-index:20;
    }
    .pill{
      min-width: 128px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.45);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      display:flex;
      gap:10px;
      align-items:baseline;
      justify-content:center;
      color:var(--text);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      letter-spacing:.08em;
    }
    .pill .k{font-size:12px;color:var(--muted);letter-spacing:.18em}
    .pill b{font-size:18px}
    .miniBtn{
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.55);
      color:var(--text);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      letter-spacing:.14em;
      font-weight:700;
    }
    .miniBtn:active{transform:translateY(1px);opacity:.9}

    /* ===== 吹き出し ===== */
    .speech{
      position:absolute;
      left: 5%;
      right: 5%;
      top: 110px;
      padding: 18px 18px;
      border-radius: 26px;
      background: rgba(255,255,255,.92);
      color:#111;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      z-index:10;
    }
    .speech::after{
      content:"";
      position:absolute;
      left: 36px;
      bottom:-14px;
      width:0;height:0;
      border:14px solid transparent;
      border-top-color: rgba(255,255,255,.92);
    }
    .speechText{
      font-size: 28px;
      font-weight: 900;
      line-height: 1.15;
      letter-spacing: .02em;
    }

    /* ===== STAGE ===== */
    .stage{
      position:absolute;
      right: 14px;
      top: calc(env(safe-area-inset-top) + 120px);
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(0,0,0,.45);
      border:1px solid var(--stroke);
      color:var(--text);
      box-shadow: var(--shadow);
      z-index:12;
      letter-spacing:.14em;
      font-weight:800;
    }

    /* ===== 旗（紙の上に載せる枠） ===== */
    .flagWrap{
      position:absolute;
      left: var(--fx);
      top: var(--fy);
      width: var(--fw);
      height: var(--fh);
      padding: var(--fp);
      border-radius: 14px;
      /* 紙の上に載ってる感（白い紙の“内側余白”） */
      background: rgba(255,255,255,.92);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      z-index:11;
    }

    /* 旗の表示領域（ここで余白を“見た目トリム”） */
    .flagViewport{
      width:100%;
      height:100%;
      border-radius: 10px;
      overflow:hidden;
      background:#fff;
      position:relative;
    }

    .flagImg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover; /* ←余白はここで切れる */
      transform: scale(var(--flag-zoom));
      transform-origin: var(--flag-ox) var(--flag-oy);
      image-rendering:auto;
    }

    /* ===== 下部（選択肢だけ最下段） ===== */
    .bottom{
      position:absolute;
      left:0; right:0;
      bottom: env(safe-area-inset-bottom);
      padding: 14px 12px 16px;
      z-index:30;
      background: linear-gradient(to top, rgba(0,0,0,.70), rgba(0,0,0,.22), rgba(0,0,0,0));
    }

    .choices{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .choiceBtn{
      height: 76px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.42);
      color: rgba(255,255,255,.92);
      font-size: 24px;
      font-weight: 900;
      letter-spacing: .06em;
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .choiceBtn:active{
      transform: translateY(1px);
      opacity:.90;
    }

    /* 小さい端末向け */
    @media (max-height: 720px){
      .speechText{font-size:24px}
      .choiceBtn{height:68px;font-size:22px}
      .stage{top: calc(env(safe-area-inset-top) + 108px)}
      :root{ --fh: 28%; --fy: 50%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="bg"></div>
    <div class="topFade"></div>

    <!-- 上部メニュー -->
    <div class="topMenu">
      <div class="pill"><span class="k">MODE</span><b id="modeText">SOLO</b></div>
      <div class="pill"><span class="k">TIME</span><b id="timeText">0.0 s</b></div>
      <button class="miniBtn" id="retryBtn">RETRY</button>
      <button class="miniBtn" id="tuneBtn">TUNE</button>
    </div>

    <!-- 吹き出し -->
    <div class="speech">
      <div class="speechText" id="speechText">どこだと思う？</div>
    </div>

    <!-- STAGE -->
    <div class="stage" id="stageText">STAGE 1</div>

    <!-- 国旗（紙の上） -->
    <div class="flagWrap" aria-label="flag on paper">
      <div class="flagViewport">
        <img class="flagImg" id="flagImg" src="flags/jp.png" alt="flag">
      </div>
    </div>

    <!-- 選択肢（最下段固定） -->
    <div class="bottom">
      <div class="choices">
        <button class="choiceBtn" id="btn0">日本</button>
        <button class="choiceBtn" id="btn1">中国</button>
        <button class="choiceBtn" id="btn2">韓国</button>
        <button class="choiceBtn" id="btn3">タイ</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== 問題データ（まずはサンプル5ヶ国） ====== */
    const FLAGS = [
      { id:"jp", name:"日本", img:"flags/jp.png", zoom:1.16, ox:"50%", oy:"50%" },
      { id:"us", name:"アメリカ", img:"flags/us.png", zoom:1.14, ox:"50%", oy:"50%" },
      { id:"fr", name:"フランス", img:"flags/fr.png", zoom:1.22, ox:"50%", oy:"50%" },
      { id:"br", name:"ブラジル", img:"flags/br.png", zoom:1.08, ox:"50%", oy:"50%" },
      { id:"au", name:"オーストラリア", img:"flags/au.png", zoom:1.12, ox:"52%", oy:"50%" },
    ];

    /* ====== DOM ====== */
    const flagImg   = document.getElementById("flagImg");
    const speechText= document.getElementById("speechText");
    const stageText = document.getElementById("stageText");
    const timeText  = document.getElementById("timeText");
    const retryBtn  = document.getElementById("retryBtn");
    const tuneBtn   = document.getElementById("tuneBtn");
    const btns      = [0,1,2,3].map(i => document.getElementById("btn"+i));

    /* ====== 状態 ====== */
    let stage = 1;
    let startAt = performance.now();
    let timerId = null;
    let current = null; // 正解の国
    let choices = [];   // 表示4択

    /* ====== Utils ====== */
    function shuffle(arr){
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }
    function pick4(correct){
      const others = FLAGS.filter(x => x.id !== correct.id);
      const picked = shuffle(others).slice(0,3);
      return shuffle([correct, ...picked]);
    }

    /* ====== タイマー ====== */
    function startTimer(){
      stopTimer();
      startAt = performance.now();
      timerId = setInterval(() => {
        const t = (performance.now() - startAt)/1000;
        timeText.textContent = t.toFixed(1) + " s";
      }, 100);
    }
    function stopTimer(){
      if (timerId){ clearInterval(timerId); timerId = null; }
    }

    /* ====== 出題 ====== */
    function applyFlagTuning(f){
      // 国ごとの「見た目トリム」微調整
      document.documentElement.style.setProperty("--flag-zoom", f.zoom ?? 1.12);
      document.documentElement.style.setProperty("--flag-ox", f.ox ?? "50%");
      document.documentElement.style.setProperty("--flag-oy", f.oy ?? "50%");
    }

    function nextQuestion(){
      current = FLAGS[Math.floor(Math.random()*FLAGS.length)];
      choices = pick4(current);

      stageText.textContent = "STAGE " + stage;
      speechText.textContent = "どこだと思う？";

      flagImg.src = current.img;
      applyFlagTuning(current);

      btns.forEach((b,i)=>{
        b.textContent = choices[i].name;
        b.disabled = false;
        b.style.opacity = "1";
      });

      startTimer();
    }

    /* ====== 回答 ====== */
    function onAnswer(i){
      btns.forEach(b => b.disabled = true);
      stopTimer();

      const picked = choices[i];
      if (picked.id === current.id){
        // 正解
        speechText.textContent = "……";
        stage++;
        setTimeout(nextQuestion, 420);
      }else{
        // 不正解（ここは好きに演出変えてOK）
        speechText.textContent = "……";
        setTimeout(nextQuestion, 650);
      }
    }

    btns.forEach((b,i)=> b.addEventListener("click", ()=>onAnswer(i)));

    retryBtn.addEventListener("click", ()=>{
      stage = 1;
      nextQuestion();
    });

    /* ====== TUNE（簡易：ズームだけ調整できる） ======
       本格チューニングは後でUI作る前提。いまはデバッグ用。 */
    tuneBtn.addEventListener("click", ()=>{
      const z = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--flag-zoom")) || 1.12;
      const next = (z >= 1.30) ? 1.06 : (z + 0.04);
      document.documentElement.style.setProperty("--flag-zoom", next.toFixed(2));
      speechText.textContent = "TUNE: zoom " + next.toFixed(2);
      setTimeout(()=> speechText.textContent = "どこだと思う？", 550);
    });

    /* 初期 */
    nextQuestion();
  </script>
</body>
</html>
