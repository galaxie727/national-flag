<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ãƒãƒ¼ã¨è¨€ãˆã°ã‚®ãƒ¥ã‚¦ã¨ç­”ãˆã‚‹</title>

<style>
*{box-sizing:border-box}
:root{
  --maxw:560px;
  --pad:16px;
  --stroke:rgba(255,255,255,.55);
  --iconFrame:8px;
  --iconRadius:14px;
}
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;
}
.app{
  max-width:var(--maxw);
  margin:0 auto;
  min-height:100svh;
  display:flex;
  flex-direction:column;
}
header{
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  font-size:12px;
  font-weight:800;
  letter-spacing:.08em;
  opacity:.95;
}

.screen{flex:1;position:relative;overflow:hidden}
.hide{display:none!important}
.bg{
  position:absolute; inset:0;
  background-size:cover;
  background-position:center;
  transform:scale(1.02);
  transition:transform .35s ease, filter .35s ease;
}
.overlay{
  position:absolute; inset:0;
  padding:var(--pad);
  display:flex;
}

.panel{
  width:100%;
  text-align:center;
  text-shadow:0 10px 28px rgba(0,0,0,.80);
}
.titleBig{
  font-size:22px;
  font-weight:900;
  letter-spacing:.14em;
  margin:0 0 14px;
}
.subLine{
  font-size:12px;
  font-weight:900;
  letter-spacing:.12em;
  opacity:.95;
  margin:0 0 16px;
}
.bigBtn{
  width:min(360px, 92%);
  font-size:18px;
  padding:16px 18px;
  border:none;
  border-radius:16px;
  background:#ffffff22;
  color:#fff;
  font-weight:900;
}

/* TOPï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸‹ã’ï¼‰ */
#topScreen .bg{ background-image:url("top_keyvisual_01.png"); }
#topScreen .overlay{
  justify-content:flex-start;
  align-items:flex-start;
  padding-top:360px; /* â†ã“ã“ã§ä¸‹ã’ã‚‹ */
}
#versionTag{
  position:absolute;
  left:0; right:0;
  bottom:18px;
  text-align:center;
  font-weight:900;
  letter-spacing:.20em;
  opacity:.85;
  text-shadow:0 10px 28px rgba(0,0,0,.75);
  pointer-events:none;
}

/* GIRL SELECT */
#girlScreen .overlay{
  justify-content:flex-start;
  align-items:flex-start;
  padding-top:120px;
}
.gridIcons{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:12px;
  margin:14px auto 18px;
  width:min(520px, 100%);
}
.girlTile{
  position:relative;
  border-radius:16px;
  overflow:hidden;
  background:rgba(255,255,255,.08);
  border:2px solid rgba(255,255,255,.00);
  padding:10px;
  text-align:left;
  -webkit-tap-highlight-color:transparent;
}
.girlTile.active{ border-color:var(--stroke); background:rgba(255,255,255,.12); }
.girlTile.locked{ opacity:.90; border-color:rgba(255,255,255,.10); }

.iconBox{
  width:100%;
  aspect-ratio:1/1;
  border-radius:var(--iconRadius);
  overflow:hidden;
  background:rgba(0,0,0,.25);
  position:relative;
}
.iconBox::before{
  content:"";
  position:absolute; inset:0;
  border-radius:var(--iconRadius);
  box-shadow: inset 0 0 0 var(--iconFrame) rgba(255,255,255,.92);
  pointer-events:none;
}
.iconBox img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
.girlName{
  margin-top:10px;
  font-weight:900;
  letter-spacing:.10em;
  font-size:13px;
  opacity:.95;
}
.lockBadge{
  position:absolute;
  top:10px; right:10px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.25);
  font-size:11px;
  font-weight:900;
  letter-spacing:.08em;
}
.rowBtns{
  display:flex;
  gap:12px;
  justify-content:center;
  align-items:center;
  flex-wrap:nowrap;
  margin-top:10px;
}
.rowBtns .bigBtn{ width:auto; flex:1; max-width:220px; }

/* MODEï¼ˆã“ã“ã‚‚ä¸‹ã’ï¼‰ */
#modeScreen .overlay{
  justify-content:flex-start;
  align-items:flex-start;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding-top:clamp(160px, 26vh, 260px);
  padding-bottom:24px;
}
.modeBtns{
  display:flex;
  flex-direction:column;
  gap:12px;
  width:min(360px, 92%);
  margin:0 auto;
}
.modeBtn{
  font-size:18px;
  padding:16px 18px;
  border:none;
  border-radius:16px;
  background:#ffffff22;
  color:#fff;
  font-weight:900;
}
.smallBack{
  margin-top:14px;
  font-size:12px;
  font-weight:900;
  letter-spacing:.12em;
  opacity:.9;
  text-decoration:underline;
  background:transparent;
  border:none;
  color:#fff;
}

/* GAME */
#gameScreen .overlay{
  flex-direction:column;
  justify-content:flex-start;
  padding-bottom:calc(env(safe-area-inset-bottom) + 16px + 130px);
}
#gameScreen.chee .bg{transform:scale(1.12)}
#gameScreen.hold .bg{filter:brightness(.92)}
#gameScreen .choices{
  position:absolute;
  left:16px;
  right:16px;
  bottom:calc(env(safe-area-inset-bottom) + 16px);
}
.vignette{
  position:absolute;inset:0;
  pointer-events:none;
  opacity:0;
  background:radial-gradient(circle, rgba(0,0,0,0) 45%, rgba(0,0,0,.45) 100%);
  transition:opacity .25s;
}
#gameScreen.chee .vignette{opacity:1}

.cut{ position:absolute;inset:0; background:#000; opacity:0; pointer-events:none; transition:opacity .28s; }
#gameScreen.cut .cut{opacity:1}

/* ===== CHEE ANNOUNCE ===== */
#gameScreen .announce{
  position:absolute;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:900;
  letter-spacing:.2em;
  text-shadow:0 10px 28px rgba(0,0,0,.85);
  pointer-events:none;
  opacity:0;
  transform:translateY(6px);
  transition:opacity .22s ease, transform .22s ease;
  z-index:50;
}
#gameScreen.announce .announce{
  opacity:1;
  transform:translateY(0);
}
#gameScreen .announce::before{
  content:"";
  position:absolute;
  width:min(420px, 86%);
  height:72px;
  border-radius:18px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.18);
  backdrop-filter: blur(6px);
}
#gameScreen .announce > span{
  position:relative;
  z-index:1;
  font-size:26px;
}

.flash{ position:absolute; inset:0; background:rgba(255,255,255,.22); opacity:0; pointer-events:none; transition:opacity .08s ease-out; }
.flash.on{ opacity:1; }

.bubble{
  position:relative;
  background:rgba(255,255,255,.08);
  border-radius:14px;
  padding:14px;
  min-height:130px;
  overflow:visible;
}
/* === ãƒ¬ã‚¤ãƒ¤ãƒ¼é †å›ºå®šï¼ˆiOSå¯¾ç­–ï¼‰ === */
#gameScreen{ isolation:isolate; }
#gameScreen .bg{ z-index:0; }
#gameScreen .vignette{ z-index:5; }
#gameScreen .overlay{ z-index:10; }   /* å¹ãå‡ºã—ï¼†ãƒœã‚¿ãƒ³ */
#gameScreen .cut{ z-index:20; }
#gameScreen .flash{ z-index:30; }
#gameScreen #resultBox{ z-index:45; }

/* â˜…å›½æ——ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã€Œå¥³ã®å­ã®æœ¨æ¿ã®å†…å´ã€ã«ç½®ãã®ã§ overlay ã‚ˆã‚Šä¸Š */
#gameScreen #panelUI{ z-index:12; }

.question{
  font-size:20px;
  font-weight:800;
  line-height:1.45;
  opacity:1;
  transition:opacity .22s;
  padding-bottom:62px;
}
.question.hide{opacity:0}

#speech{
  position:absolute;
  right:14px;
  bottom:10px;
  text-align:right;
  pointer-events:none;
  font-size:clamp(22px, 6vw, 34px);
  font-weight:900;
  letter-spacing:.10em;
  line-height:1.1;
  max-width:88%;
  white-space:pre-line;
  word-break:break-word;
  overflow:visible;
  text-shadow:0 10px 28px rgba(0,0,0,.75);
}
.cheeWord.big{ transform:scale(1.06); transform-origin:right bottom; }

.heartOnly{ color:#ff2d55; text-shadow:0 8px 22px rgba(255,45,85,.35); }
.heartGold{ color:#ffd54a; text-shadow:0 10px 26px rgba(255,213,74,.45); }
@keyframes heartPop{
  0%{ transform:scale(0.8); opacity:0; }
  55%{ transform:scale(1.25); opacity:1; }
  100%{ transform:scale(1); opacity:1; }
}
.heartPop{ animation:heartPop .22s ease-out; }

@keyframes bgShake {
  0%   { transform: translate(0, 0) scale(1.12); }
  20%  { transform: translate(-2px, 1px) scale(1.12); }
  40%  { transform: translate(2px, -1px) scale(1.12); }
  60%  { transform: translate(-1px, -2px) scale(1.12); }
  80%  { transform: translate(1px, 2px) scale(1.12); }
  100% { transform: translate(0, 0) scale(1.12); }
}
#gameScreen.chee.stage3plus .bg{ animation:bgShake .35s infinite; }

.choices{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.choice{
  padding:14px;
  border:none;
  border-radius:12px;
  font-size:16px;
  font-weight:900;
  color:#fff;
}
.choice:disabled{opacity:.55}
.choices.chee10 .choice{ padding:12px; font-size:14px; border-radius:12px; }

.gauge{
  height:8px;
  background:#222;
  border-radius:999px;
  overflow:hidden;
  opacity:0;
  transform:translateY(8px);
  transition:opacity .16s, transform .16s;
  margin-bottom:10px;
}
.gauge.show{ opacity:1; transform:translateY(0); }
.gauge>div{
  height:100%;
  width:100%;
  transform-origin:left;
  transform:scaleX(0);
}
#gaugeBar.yellow{ background:linear-gradient(90deg,#ffe259,#ffa751); }
#gaugeBar.red{ background:linear-gradient(90deg,#ff416c,#ff4b2b); }

#gameScreen.result #question{ display:none; }

#resultBox{
  position:absolute;
  left:16px; right:16px;
  bottom:135px;
  pointer-events:none;
  text-shadow:0 10px 28px rgba(0,0,0,.75);
}
#resultBox .label{
  font-size:18px;
  font-weight:900;
  letter-spacing:.10em;
  margin-bottom:12px;
}
#resultBox .pctRow{ display:flex; justify-content:flex-end; align-items:baseline; }
#resultBox .pct{ font-size:88px; font-weight:900; line-height:1; }
#resultBox .pct small{ font-size:20px; opacity:.95; margin-left:2px; }

/* ===== RESULTï¼šç™½åœ°ï¼‹é»’æ–‡å­— / å°ã•ã‚å¹ãå‡ºã— ===== */
#gameScreen.result .bubble{
  background:rgba(255,255,255,.90);
  border-radius:22px;
  padding:16px 18px;
  box-shadow:0 12px 30px rgba(0,0,0,.35);
  min-height:0;
  display:flex;
  justify-content:flex-end;
  align-items:flex-end;
}
#gameScreen.result #speech{
  position:static;
  margin:0 auto;
  text-align:center;
  font-size:20px;
  font-weight:900;
  letter-spacing:.06em;
  line-height:1.25;
  color:#111;
  text-shadow:none;
  max-width:100%;
  white-space:normal;
  pointer-events:none;
}
#gameScreen.result #speech .heartOnly{ text-shadow:none; }

/* =========================
   â˜…å›½æ——ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆæœ¨æ¿ã®å†…å´ãƒ‘ãƒãƒ«ã«é‡ã­ã‚‹ï¼‰
   â€»ä½ç½®ã¯ã“ã®1äººã®ç”»åƒã«åˆã‚ã›ãŸã€ŒåˆæœŸå€¤ã€
   â€»ä»–ã®å­ã§ã‚ºãƒ¬ãŸã‚‰ã“ã“ã‚’å¾®èª¿æ•´ã™ã‚‹ã ã‘
========================= */
#panelUI{
  position:absolute;
  /* æœ¨æ¿ã®å†…å´ãƒ‘ãƒãƒ«ä½ç½®ï¼ˆåˆæœŸãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼‰ */
  left: 18%;
  top: 63%;
  width: 64%;
  height: 15%;

  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;

  pointer-events:none;
  user-select:none;
}
#flagLayer{
  width:100%;
  height:100%;
  object-fit:contain; /* æ——ãŒã¯ã¿å‡ºã•ãªã„ */
  display:block;
  filter: drop-shadow(0 6px 14px rgba(0,0,0,.25));
}
#countryLabel{
  position:absolute;
  left:0; right:0;
  bottom:-24px;
  text-align:center;
  font-weight:900;
  letter-spacing:.12em;
  font-size:12px;
  opacity:.92;
  text-shadow:0 10px 28px rgba(0,0,0,.75);
  display:none; /* â†å›½åå‡ºã—ãŸã„ãªã‚‰ block ã« */
}
</style>
</head>

<body>
<div class="app">
<header>
  <div>ãƒãƒ¼ã¨è¨€ãˆã°ã‚®ãƒ¥ã‚¦ã¨ç­”ãˆã‚‹</div>
  <div id="counter">-</div>
</header>

<!-- TOP -->
<div id="topScreen" class="screen">
  <div class="bg"></div>
  <div class="overlay">
    <div class="panel">
      <h1 class="titleBig">ã‚¬ãƒï¼ãƒãƒ¼ç‰›è¨ºæ–­ï¼ï¼</h1>
      <button class="bigBtn" id="btnGoGirl">START</button>
    </div>
  </div>
  <div id="versionTag">VERSION <span id="versionVal"></span></div>
</div>

<!-- GIRL SELECT -->
<div id="girlScreen" class="screen hide">
  <div class="bg"></div>
  <div class="overlay">
    <div class="panel">
      <h1 class="titleBig">å¥³ã®å­ã‚’é¸ã‚“ã§ã­</h1>
      <div class="gridIcons" id="girlGrid"></div>
      <div class="rowBtns" style="margin-top:14px;">
        <button class="bigBtn" id="btnGirlBack">æˆ»ã‚‹</button>
        <button class="bigBtn" id="btnGoMode">æ¬¡ã¸</button>
      </div>
    </div>
  </div>
</div>

<!-- MODE SELECT -->
<div id="modeScreen" class="screen hide">
  <div class="bg"></div>
  <div class="overlay">
    <div class="panel">
      <h1 class="titleBig">ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­</h1>
      <div class="subLine" id="bestLine">ãƒãƒ¼å¨˜ BESTï¼šã‚¹ãƒ†ãƒ¼ã‚¸0</div>

      <div class="modeBtns">
        <button class="modeBtn" id="btnStartQuiz">ãƒãƒ¼ç‰›è¨ºæ–­</button>
        <button class="modeBtn" id="btnStartChee">ãƒãƒ¼å¨˜ãƒ¢ãƒ¼ãƒ‰</button>

        <button class="modeBtn" id="btnQuizLen">ğŸ§© å‡ºé¡Œæ•°ï¼š45å•</button>
        <div class="subLine" id="quizLenNote" style="margin-top:-4px; opacity:.9; display:none;">
          25å•ã¯èª²é‡‘ã§è§£æ”¾
        </div>

        <button class="modeBtn" id="btnToggleAllStar">â­ ã‚ªãƒ¼ãƒ«ã‚¹ã‚¿ãƒ¼ï¼šOFF</button>
        <div class="subLine" id="allStarNote" style="margin-top:-4px; opacity:.9;">
          ã‚ªãƒ¼ãƒ«ã‚¹ã‚¿ãƒ¼ã¯èª²é‡‘ã§è§£æ”¾
        </div>
      </div>

      <button class="smallBack" id="btnModeBack">å¥³ã®å­é¸æŠã«æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="gameScreen" class="screen hide">
  <div class="bg"></div>
  <div class="vignette"></div>
  <div class="cut"></div>
  <div class="flash" id="flash"></div>
  <div class="announce"><span>ãƒãƒ¼å¨˜ç™»å ´ï¼ï¼</span></div>

  <!-- â˜…å›½æ——ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
  <div id="panelUI" class="hide">
    <img id="flagLayer" src="" alt="">
    <div id="countryLabel"></div>
  </div>

  <div id="resultBox" class="hide">
    <div class="label">ã‚ãªãŸã®ãƒãƒ¼ç‰›åº¦ã¯</div>
    <div class="pctRow"><div class="pct" id="resultPct">0<small>%</small></div></div>
  </div>

  <div class="overlay">
    <div class="bubble" id="bubble">
      <div id="question" class="question"></div>
      <div id="speech"></div>
    </div>

    <div class="gauge" id="gaugeWrap"><div id="gaugeBar"></div></div>
    <div class="choices" id="choices"></div>
  </div>
</div>

</div>

<script>
/* =========================
   DEBUG
========================= */
const DEBUG_GIFTED = true; // â†ãƒã‚®ãƒ¥ãƒ†ãƒƒãƒ‰ç¢ºèªã—ãŸã„æ™‚ã ã‘ true
const DEBUG = true;        // â†åˆ¶ä½œä¸­ã¯trueã§OKã€‚åˆ‡ã‚ŠãŸã„æ™‚ã ã‘false

window.onerror = function (msg, src, line, col, err) {
  const text =
    "JS ERROR:\n" + msg + "\n" +
    "line: " + line + " col: " + col + "\n" +
    (err && err.stack ? err.stack : "") + "\n" +
    (src ? ("src: " + src) : "");

  let box = document.getElementById("errBox");
  if(!box){
    box = document.createElement("pre");
    box.id = "errBox";
    box.style.position = "fixed";
    box.style.left = "10px";
    box.style.right = "10px";
    box.style.bottom = "10px";
    box.style.maxHeight = "40vh";
    box.style.overflow = "auto";
    box.style.zIndex = "99999";
    box.style.background = "rgba(0,0,0,.88)";
    box.style.border = "2px solid rgba(255,0,0,.6)";
    box.style.padding = "10px";
    box.style.fontSize = "12px";
    box.style.whiteSpace = "pre-wrap";
    box.style.borderRadius = "12px";
    box.style.pointerEvents = "auto";
    box.style.userSelect = "text";
    box.onclick = ()=> box.remove();
    document.body.appendChild(box);
  }
  box.textContent = text;
  return true;
};

/* =========================
   v3.0203 + FLAGS LAYER
========================= */
const APP_VERSION = "v3.0203+flags";
document.getElementById("versionVal").textContent = APP_VERSION;

/* keys */
const CHEE_RECORD_KEY = "cheeGirlBestStage";
const GIRL_KEY = "selectedGirlKey";
const GIRL_PREVIEW_KEY = "girlPreviewBgKey";
const UNLOCK_KEY = "unlockedGirls";

const QUIZ_LEN_KEY = "quizLengthMode";
const QUIZ25_UNLOCK_KEY = "quiz25Unlocked";

/* storage helpers */
function getBestStage(){ return Number(localStorage.getItem(CHEE_RECORD_KEY)) || 0; }
function setBestStage(stage){ localStorage.setItem(CHEE_RECORD_KEY, String(stage)); }
function getSavedGirl(){ return localStorage.getItem(GIRL_KEY) || "A"; }
function saveGirl(g){ localStorage.setItem(GIRL_KEY, g); }
function getPreviewKey(){ return localStorage.getItem(GIRL_PREVIEW_KEY) || ""; }
function setPreviewKey(k){ localStorage.setItem(GIRL_PREVIEW_KEY, k); }

/* unlocked default */
(function ensureUnlockedDefault(){
  if(!DEBUG) return;
  try{
    const cur = JSON.parse(localStorage.getItem(UNLOCK_KEY) || "[]");
    const base = Array.isArray(cur) ? cur : [];
    const need = ["A","B","C","D","E","F"];
    const merged = Array.from(new Set([...base, ...need]));
    localStorage.setItem(UNLOCK_KEY, JSON.stringify(merged));
  }catch(e){
    localStorage.setItem(UNLOCK_KEY, JSON.stringify(["A","B","C","D","E","F"]));
  }
})();

/* utils */
function shuffle(a){ return a.slice().sort(()=>Math.random()-0.5); }
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function safePick(list, fallback){
  if(Array.isArray(list) && list.length) return pick(list);
  return fallback || "";
}

/* =========================
   â˜…FLAGSï¼ˆ5ã¤å›ºå®šï¼‰
   ãƒ•ã‚¡ã‚¤ãƒ«åï¼šjapan.png usa.png france.png australia.png brazil.png
========================= */
const FLAGS = [
  { key:"japan",     label:"æ—¥æœ¬",           img:"japan.png" },
  { key:"usa",       label:"ã‚¢ãƒ¡ãƒªã‚«",       img:"usa.png" },
  { key:"france",    label:"ãƒ•ãƒ©ãƒ³ã‚¹",       img:"france.png" },
  { key:"australia", label:"ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢", img:"australia.png" },
  { key:"brazil",    label:"ãƒ–ãƒ©ã‚¸ãƒ«",       img:"brazil.png" }
];

function showFlagByKey(k){
  const v = FLAGS.find(x=>x.key===k);
  if(!v) return;

  const ui  = document.getElementById("panelUI");
  const img = document.getElementById("flagLayer");
  const lab = document.getElementById("countryLabel");

  img.src = v.img;
  img.alt = v.label;
  lab.textContent = v.label;

  ui.classList.remove("hide");
}
function showRandomFlag(){
  const v = FLAGS[Math.floor(Math.random()*FLAGS.length)];
  showFlagByKey(v.key);
}
function hideFlag(){
  document.getElementById("panelUI").classList.add("hide");
}

/* girls */
function makeGirl(prefix, key, name, locked=false, chiOverText="â€¦â€¦", replies={}, scoreText={}){
  const NORMAL_COUNT = 3; // â˜…ã“ã“ã‚’3æšã«ï¼ˆè»½é‡åŒ–ï¼‰
  const normal = Array.from({length:NORMAL_COUNT}, (_,i)=> `${prefix}_normal_${String(i+1).padStart(2,"0")}.png`);

  return {
    key, name, locked,
    icon: `${prefix}_icon.png`,
    top:  `${prefix}_top_01.png`,
    normal,
    gameover: `${prefix}_gameover_01.png`,
    chiGameover: `${prefix}_chi_gameover_01.png`,
    chiOverText,
    score: {
      s80:  `${prefix}_score_80.png`,
      s90:  `${prefix}_score_90.png`,
      s95:  `${prefix}_score_95.png`,
      s100: `${prefix}_score_100.png`
    },
    scoreText: {
      s80:  scoreText.s80  ?? "",
      s90:  scoreText.s90  ?? "",
      s95:  scoreText.s95  ?? "",
      s100: scoreText.s100 ?? ""
    },
    replies: {
      yes:  replies.yes  ?? "ç¬‘",
      no:   replies.no   ?? "ã‚¯ã‚¹ãƒƒ",
      gyuu: replies.gyuu ?? "ãƒ‹ã‚³ãƒƒ",
      chi:  replies.chi  ?? "ã‚®ãƒ¥ã‚¦"
    }
  };
}
function makeGirlLite(prefix, key, name){
  return {
    key, name, locked:true,
    icon: `${prefix}_icon.png`,
    top: `${prefix}_top_01.png`,
    normal: [],
    gameover: "",
    chiGameover: "",
    chiOverText: "ï¼ˆLOCKEDï¼‰",
    score: {}
  };
}

const GIRLS = [
  makeGirl("girlA","A","Girl A", false, "â€¦â€¦ï¼ˆãƒãƒ¼å¨˜Aã¯ç„¡è¨€ã§å»ã£ã¦ã„ã£ãŸï¼‰",
    { yes:"ãµãµ", no:"â€¦â€¦", gyuu:"ã«ã“", chi:"ã‚®ãƒ¥ã‚¦" },
    { s80:"ã‚„ã£ã±ã‚Šãƒãƒ¼ç‰›ã ã£ãŸã­", s90:"ã†ã‚“ã€ãƒãƒ¼ç‰›å¯„ã‚Šã‹ãª", s95:"ã‹ãªã‚Šãƒãƒ¼ç‰›ã ã¨æ€ã†", s100:"â€¦â€¦ã‚ãªãŸã€ãƒã‚®ãƒ¥ãƒ†ãƒƒãƒ‰ã ã‚ˆ" }
  ),
  makeGirl("girlB","B","Girl B", false, "â€¦â€¦ï¼ˆãƒãƒ¼å¨˜Bï¼šè¦‹ãªã‹ã£ãŸã“ã¨ã«ã™ã‚‹ã­ï¼‰",
    { yes:"ã†ã‚“", no:"ã¡ãŒã†ã‚ˆ", gyuu:"ãˆã¸", chi:"ã‚®ãƒ¥ã‚¦" },
    { s80:"è¦‹ãŸç¬é–“ã€ãƒãƒ¼ç‰›ã ã¨æ€ã£ãŸ", s90:"ã¾ã‚â€¦ãƒãƒ¼ç‰›ã ã­", s95:"ãƒãƒ¼ç‰›ã©çœŸã‚“ä¸­ã‹ãª", s100:"ã“ã‚Œã¯åˆ¥æ ¼ã€‚ãƒã‚®ãƒ¥ãƒ†ãƒƒãƒ‰ã ã­" }
  ),
  makeGirl("girlC","C","Girl C", false, "â€¦â€¦ï¼ˆãƒãƒ¼å¨˜Cï¼šæ¬¡ã¯ã¡ã‚ƒã‚“ã¨ã—ã¦ï¼Ÿï¼‰",
    { yes:"ã‚ˆã—", no:"ã ã‚", gyuu:"ã¸ã¸", chi:"ã‚®ãƒ¥ã‚¦" },
    { s80:"ãƒãƒ¼ç‰›ã£ã½ã„ã­", s90:"ã†ã‚“ã†ã‚“ã€ãƒãƒ¼ç‰›ã ã­", s95:"ã‹ãªã‚Šãƒãƒ¼ç‰›ã§å¥½ã", s100:"ã™ã”ã£â€¦ãƒã‚®ãƒ¥ãƒ†ãƒƒãƒ‰ã˜ã‚ƒã‚“" }
  ),
  makeGirl("girlD","D","Girl D", false, "â€¦â€¦ï¼ˆãƒãƒ¼å¨˜Dï¼šè©¦é‹è»¢ä¸­ï¼‰",
    { yes:"ãµãƒ¼ã‚“", no:"ã¾ã‚ã­", gyuu:"ã«ã‚„", chi:"ã‚®ãƒ¥ã‚¦" },
    { s80:"ãƒãƒ¼ç‰›ã ã¨æ€ã†", s90:"ã¾ã‚ã€ãƒãƒ¼ç‰›ã ã‚ˆã­", s95:"ã“ã“ã¾ã§æ¥ã‚‹ã¨ãƒãƒ¼ç‰›ã®æ‰èƒ½", s100:"æ‰èƒ½ã®å¡Šã€‚ãƒã‚®ãƒ¥ãƒ†ãƒƒãƒ‰" }
  ),
  makeGirl("girlE","E","Girl E", false, "â€¦â€¦ï¼ˆãƒãƒ¼å¨˜Eï¼šè©¦é‹è»¢ä¸­ï¼‰",
    { yes:"OK", no:"NO", gyuu:"ã‚ˆã—", chi:"ã‚®ãƒ¥ã‚¦" },
    { s80:"ã‚„ã£ã±ãƒãƒ¼ç‰›ã ã£ãŸã‹", s90:"ãƒãƒ¼ç‰›æ„Ÿã€éš ã›ã¦ãªã„ã­", s95:"ç«‹æ´¾ãªãƒãƒ¼ç‰›ã ã¨æ€ã†", s100:"ã“ã‚Œã¯ã‚‚ã†â€¦ãƒã‚®ãƒ¥ãƒ†ãƒƒãƒ‰" }
  ),
  makeGirlLite("girlF","F","Girl F")
];

function getGirlByKey(k){ return GIRLS.find(x=>x.key===k) || GIRLS[0]; }
let selectedGirlKey = getSavedGirl();
function getSelectedGirl(){ return getGirlByKey(selectedGirlKey); }

/* questions (45) */
const questions = [
  { text:"ã‚ãªãŸã¯ãƒãƒ¼ç‰›ã§ã™ã‹ï¼Ÿ" },
  { text:"ãƒãƒ¼ã¨è¨€ãˆã°ï¼Ÿ" },
  { text:"ç‰›ä¸¼å±‹ã•ã‚“ã®CMã«å‡ºã¦ã„ã‚‹çŸ³åŸã•ã¨ã¿ã•ã‚“ã«ã€Œãƒãƒ¼ã€ã¨è¨€ã‚ã‚ŒãŸã‚‰ï¼Ÿ" },
  { text:"çŸ³åŸã•ã¨ã¿ã•ã‚“ã«å‘ã‹ã£ã¦ã€Œãƒãƒ¼ã€ã¨è¨€ã£ãŸã‚‰ã€Œã‚®ãƒ¥ã‚¦ã€ã¨ç­”ãˆã¦ãã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’é–‹å‚¬ã—ã¦æ¬²ã—ããªã„ã§ã™ã‹ï¼Ÿ" },
  { text:"çŸ³åŸã•ã¨ã¿ã•ã‚“ã«ã‚ã®ç¬‘é¡”ã§ã€Œã‚®ãƒ¥ã‚¦ã€ã¨ç­”ãˆã¦ã‚‚ã‚‰ãˆãŸã‚‰è†ã‹ã‚‰å´©ã‚Œè½ã¡ãšã«ã„ã‚‰ã‚Œã¾ã™ã‹ï¼Ÿ" },
  { text:"ç‰›ä¸¼å±‹ã•ã‚“ã®CMã«ã‚‚å‡ºã¦ã„ã‚‹ã—çš†ã‚“ãªãŒæœ¬æ°—ã§å®Ÿç¾ã•ã›ã‚ˆã†ã¨æ€ãˆã°å®Ÿç¾å‡ºæ¥ãã†ãªæ°—ãŒã—ã¾ã›ã‚“ã‹ï¼Ÿ" },
  { text:"ãƒãƒ¼ã‚ºç‰›ä¸¼ã‚’é ¼ã‚“ã äººã®é¡”ã‚’ã¤ã„ãƒãƒ©è¦‹ã—ã¦ã—ã¾ã£ãŸäº‹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ" },
  { text:"çŸ¥ã‚‰ãªã„äººã‚’è¦‹ã¦ã€ãƒãƒ¼ç‰›ã‹ã‚‚ã€ã¨æ€ã£ã¦ã—ã¾ã£ãŸã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ" },
  { text:"çŸ¥ã‚‰ãªã„äººã«è¦‹ã‚‰ã‚Œã¦ã€Œãƒãƒ¼ç‰›ã‹ã‚‚ã€ã¨æ€ã‚ã‚Œã¦ã„ãã†ã«æ„Ÿã˜ãŸã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ" },
  { text:"ã‚ãªãŸã®å‹äººã«ãƒãƒ¼ç‰›ã¯ã„ã¾ã™ã‹ï¼Ÿ" },
  { text:"å¤§è°·ç¿”å¹³é¸æ‰‹ãŒå…¨å›½ã®å°å­¦ç”Ÿã«ã‚°ãƒ­ãƒ¼ãƒ–ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã—ãŸéš›ã®ã€Œé‡çƒã—ã‚ˆã†ãœï¼ã€ã¨ã„ã†è¨€è‘‰ã‚«ãƒƒã‚³è‰¯ã‹ã£ãŸã§ã™ã­ï¼" },
  { text:"å¤§è°·ç¿”å¹³é¸æ‰‹ã¯ã‚³ãƒ³ãƒ“ãƒ‹ã®ãŠã«ãã‚Šã®CMã«å‡ºã¦ã„ã¾ã™ãŒã€ŒãŠã«ãã‚Šé£ŸãŠã†ãœï¼ã€ã®æ–¹ãŒè‰¯ã‹ã£ãŸã¨æ€ã„ã¾ã™ã‹ï¼Ÿ" },
  { text:"å¤§è°·ç¿”å¹³é¸æ‰‹ã«ã¯æ˜¯éã¨ã‚‚ãƒãƒ¼ã‚ºç‰›ä¸¼ã®CMã«å‡ºã¦é ‚ãã€Œãƒãƒ¼ç‰›é£ŸãŠã†ãœï¼ã€ã¨è¨€ã£ã¦æ¬²ã—ã„ã§ã™ã‹ï¼Ÿ" },
  { text:"ãƒã‚¤ãƒãƒ¼ã‚ºã‚’ãƒã‚¤ãƒãƒ¼ç‰›ã ã¨æ€ã£ã¦ã„ãŸæ™‚æœŸãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ" },
  { text:"å†™çœŸã‚’æ’®ã‚‹æ™‚ã«ãƒãƒ¼ã‚ºç‰›ä¸¼ã‚’æŒã£ã¦ãƒã‚¤ãƒãƒ¼ç‰›ã‚’ã—ã¦ã—ã¾ã£ãŸäº‹ãŒã‚ã‚‹ã€‚" },
  { text:"éº»é›€ã«ã¯ã€ãƒãƒ¼ã‚’ã•ã‚ŒãŸç¬é–“ã«ã‚®ãƒ¥ã‚¦ã¨ç­”ãˆã‚‹ã¨ãƒãƒ¼ã‚’å–ã‚Šæ¶ˆã™ã€ãƒãƒ¼ã‚®ãƒ¥ã‚¦è¿”ã—ã€ãŒã‚ã‚‹ã€‚" },
  { text:"ã‚ãªãŸã¯ä¸‰åº¦ã®é£¯ã‚ˆã‚Šãƒãƒ¼ã‚ºç‰›ä¸¼ãŒå¥½ãã§ã™ã‹ï¼Ÿ" },
  { text:"æ°—ä»˜ãã¨ã€ãƒãƒ¼ã€ã€ã‚®ãƒ¥ã‚¦ã€ã€ãƒãƒ¼ã€ã€ã‚®ãƒ¥ã‚¦ã€ã¨äº¤äº’ã«è¨€ã£ã¦ã„ã‚‹äº‹ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ" },
  { text:"å±±æœ¬ç”±ä¼¸é¸æ‰‹ã®ã€Œè² ã‘ã‚‹ã¨è¨€ã†é¸æŠè‚¢ã¯ãªã„ã€ã¨ã„ã†åè¨€ã¯ã¨ã¦ã‚‚ã‚«ãƒƒã‚³è‰¯ã‹ã£ãŸã§ã™ã­ï¼Ÿ" },
  { text:"å±±æœ¬ç”±ä¼¸é¸æ‰‹ã«ã€Œãƒãƒ¼ã‚ºç‰›ä¸¼ã‚’é£Ÿã¹ãªã„ã¨ã„ã†é¸æŠè‚¢ã¯ãªã„ã€ã¨è¨€ã£ã¦ã‚‚ã‚‰ã„ãŸã„ã§ã™ã‹ï¼Ÿ" },
  { text:"ã‚®ãƒªã‚·ãƒ£ã®å“²å­¦è€…ã‚¢ãƒªã‚¹ãƒˆãƒ†ãƒ¬ã‚¹ã®ã€Œã™ã¹ã¦ã®è€…ã¯ç”Ÿã¾ã‚ŒãªãŒã‚‰ã«çŸ¥æµã‚’æ±‚ã‚ã‚‹ã€‚ã€æœ‰åãªåè¨€ã¯çŸ¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ" },
  { text:"ãƒãƒ¼ç‰›ç•Œéšˆã«ã‚‚ã€Œã™ã¹ã¦ã®è€…ã¯ç”Ÿã¾ã‚ŒãªãŒã‚‰ã«ãƒãƒ¼ã‚ºç‰›ä¸¼ã‚’æ±‚ã‚ã‚‹ã€‚ã€ã¨ã„ã†åè¨€ãŒã‚ã‚‹ã®ã‚’çŸ¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ" },
  { text:"ã€ã‚®ãƒ¥ã‚¦ã€ã¨ç­”ãˆã‚‹ç·´ç¿’ã‚’ã—ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ" },
  { text:"ç‰›ä¸¼å±‹ã§ã€ãƒãƒ¼ã‚ºã€ã®æ–‡å­—ã‚’è¦‹ã‚‹ã¨ä¸€ç¬è¿·ã„ã¾ã™ã‹ï¼Ÿ" },
  { text:"ã‚³ãƒ³ãƒ“ãƒ‹ã§ãƒãƒ¼ã‚ºç³»ã‚’è¦‹ã‚‹ã¨ã€ãªãœã‹å¿ƒãŒã–ã‚ã¤ãã¾ã™ã‹ï¼Ÿ" },
  { text:"ã€ãƒãƒ¼ã€ã¨èã“ãˆãŸã‚‰åå°„çš„ã«ã€ã‚®ãƒ¥ã‚¦ã€ãŒé ­ã«æµ®ã‹ã³ã¾ã™ã‹ï¼Ÿ" },
  { text:"ã€ã‚®ãƒ¥ã‚¦ã€ã¨è¨€ã†æ™‚ã€ãªãœã‹èª‡ã‚‰ã—ã„æ°—æŒã¡ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ" },
  { text:"ãƒãƒ¼ã‚ºç‰›ä¸¼ã‚’é£Ÿã¹ãŸå¾Œã€ã¡ã‚‡ã£ã¨å¼·ããªã£ãŸæ°—ãŒã—ã¾ã™ã‹ï¼Ÿ" },
  { text:"ãƒãƒ¼ã¨è¨€ã‚ã‚Œã‚‹ã¨ã€å°‘ã—ã ã‘åå¿œã—ã¦ã—ã¾ã„ã¾ã™ã‹ï¼Ÿ" },
  { text:"ã€ãƒãƒ¼ç‰›ã€ã¨ã„ã†è¨€è‘‰ã‚’ã€å¿ƒã®ä¸­ã ã‘ã§ä½¿ã£ãŸã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ" },
  { text:"ã‚ãªãŸã¯ãƒãƒ¼ç‰›ã‚’ã€æ‚ªå£ã€ã§ã¯ãªãã€æ¦‚å¿µã€ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ" },
  { text:"ãƒãƒ¼ã‚ºç‰›ä¸¼ã‚’ã€æ¥ãšã‹ã—ãã¦é ¼ã‚ãªã„ã€äººã¯å®Ÿåœ¨ã™ã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ" },
  { text:"ã‚ãªãŸã¯ã€é ¼ã‚ãªã„ãŒã€æœ¬å½“ã¯é£Ÿã¹ãŸã„ã€å´ã§ã™ã‹ï¼Ÿ" },
  { text:"ãƒãƒ¼ã‚ºç‰›ä¸¼ã‚’é ¼ã‚€äººã‚’è¦‹ã‚‹ã¨ã€ãªãœã‹ç›®ãŒè¡Œãã¾ã™ã‹ï¼Ÿ" },
  { text:"ã€ãƒãƒ¼ç‰›ã‹ã‚‚ã€ã¨æ€ã£ã¦ã‚‚ã€å£ã«ã¯å‡ºã—ã¾ã›ã‚“ã‹ï¼Ÿ" },
  { text:"ã€ãƒãƒ¼ã¨è¨€ãˆã°ã‚®ãƒ¥ã‚¦ã€ã¨èã„ã¦ã€å°‘ã—å®‰å¿ƒã—ã¾ã™ã‹ï¼Ÿ" },
  { text:"ã‚ãªãŸã¯è‡ªåˆ†ãŒãƒãƒ¼ç‰›ã‹ã©ã†ã‹ã€æ™‚ã€…ç¢ºèªã—ãŸããªã‚Šã¾ã™ã‹ï¼Ÿ" },
  { text:"ã€ãƒãƒ¼ã€ã¨ã€ã‚®ãƒ¥ã‚¦ã€ã®é–¢ä¿‚ã¯ã€ã‚‚ã¯ã‚„é‹å‘½ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ" },
  { text:"ã€ãƒãƒ¼ã¨è¨€ãˆã°ã‚®ãƒ¥ã‚¦ã€ã¯ã€äººç”Ÿã®ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒãƒƒãƒˆã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ" },
  { text:"ãƒãƒ¼ã¨è¨€ã‚ã‚ŒãŸã‚‰ã€ã‚®ãƒ¥ã‚¦ã¨è¿”ã—ãŸã„ã§ã™ã‹ï¼Ÿ" },
  { text:"ã‚®ãƒ¥ã‚¦ã¨è¨€ã£ãŸã‚‰ã€ç›¸æ‰‹ã«â¤ã§è¿”ã—ã¦ã»ã—ã„ã§ã™ã‹ï¼Ÿ" },
  { text:"ã€ã‚®ãƒ¥ã‚¦ã€ã¨ç­”ãˆã‚‹ã¨ä¸–ç•ŒãŒå°‘ã—å¹³å’Œã«ãªã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ" },
  { text:"æœ€å¾Œã«ã²ã¨ã“ã¨ã€‚ãƒãƒ¼ã¨è¨€ãˆã°ï¼Ÿ" }
];

/* ===== 45åŸºæœ¬ / èª²é‡‘ã§25è§£æ”¾ ===== */
let quiz25Unlocked = DEBUG ? true : false;
let quizLengthMode = "45";
let playQuestions = [];

function makePlayQuestions(){
  const all = questions.slice();
  if(quizLengthMode !== "25") return all;

  const first = all[0];
  const last  = all[all.length - 1];
  const midPool = all.slice(1, all.length - 1);
  const mid = shuffle(midPool).slice(0, 23);
  return [first, ...mid, last];
}

/* chee settings */
const cheeLevelsNormal = [
  { stars:1, timeMs:2400, gauge:"cool",   weight:0.60 },
  { stars:2, timeMs:1700, gauge:"yellow", weight:0.30 },
  { stars:3, timeMs:1200, gauge:"red",    weight:0.10 }
];
const CHEE_RATE = 0.35;

const QUESTION_SHOW_DELAY     = 120;
const GIRL_REPLY_DELAY_MS     = 520;
const NORMAL_REACT_MS         = 980;

const CHEE_PRE_HOLD_MS        = 760;
const CUT_MS                  = 420;
const POST_CUT_HOLD_MS        = 360;
const CHEE_SILENCE_MS         = 260;
const CHEE_SUCCESS_HOLD_MS    = 820;

const FLASH_ON_MS             = 120;

const STAGE3_BOOST_MS = 500;
const STAGE3_BOOST_MULT = 1.35;

/* score */
function rollScore(){
  if(DEBUG && DEBUG_GIFTED) return 100;
  const r = Math.random();
  if(r < 0.02) return 100;
  return randInt(80, 99);
}
function rankFromScore(p){
  if(p === 100) return "gifted";
  if(p >= 95) return "s";
  if(p >= 88) return "a";
  return "b";
}
function scoreToKey(score){
  if(score === 100) return "s100";
  if(score >= 95)  return "s95";
  if(score >= 90)  return "s90";
  return "s80";
}

/* DOM */
const counterEl   = document.getElementById("counter");
const topScreen   = document.getElementById("topScreen");
const girlScreen  = document.getElementById("girlScreen");
const modeScreen  = document.getElementById("modeScreen");
const gameScreen  = document.getElementById("gameScreen");

const girlBg      = document.querySelector("#girlScreen .bg");
const modeBg      = document.querySelector("#modeScreen .bg");
const gameBg      = document.querySelector("#gameScreen .bg");

const girlGrid    = document.getElementById("girlGrid");
const bestLine    = document.getElementById("bestLine");

const qEl         = document.getElementById("question");
const speechEl    = document.getElementById("speech");
const choicesEl   = document.getElementById("choices");

const gaugeWrap   = document.getElementById("gaugeWrap");
const gaugeBar    = document.getElementById("gaugeBar");
const flashEl     = document.getElementById("flash");

const resultBox   = document.getElementById("resultBox");
const resultPct   = document.getElementById("resultPct");

const btnToggleAllStar = document.getElementById("btnToggleAllStar");
const allStarNote = document.getElementById("allStarNote");

const btnQuizLen = document.getElementById("btnQuizLen");
const quizLenNote = document.getElementById("quizLenNote");

/* state */
let gameMode = "quiz";
let mode = "quiz";
let locked = false;
let ended = false;
let i = 0;

let rafId = 0;
let cheeCooldown = false;
let lastGyuuIndex = -1;
let cheeStage = 1;
let isNewRecordRun = false;

let previewBgKey = getPreviewKey() || "";

/* ã‚¿ã‚¤ãƒãƒ¼ç®¡ç† */
let cheeTimeouts = [];
function tset(fn, ms){
  const id = setTimeout(fn, ms);
  cheeTimeouts.push(id);
  return id;
}
function clearCheeTimeouts(){
  cheeTimeouts.forEach(clearTimeout);
  cheeTimeouts = [];
}

/* =====================
   ALL STAR
===================== */
const ALLSTAR_ENABLED_KEY = "allStarEnabled";
let allStarUnlocked = DEBUG ? true : false;
let allStarEnabled = false;

function getUnlockedGirls(){
  try{
    const a = JSON.parse(localStorage.getItem(UNLOCK_KEY) || "[]");
    if(Array.isArray(a) && a.length) return a;
  }catch(e){}
  return ["A","B","C"];
}

let allStarBag = [];
let allStarLastKey = "";

function getAllStarKeysAvailable(){
  const unlocked = getUnlockedGirls();
  const keys = unlocked.filter(k=>{
    const g = getGirlByKey(k);
    return g && !g.locked && Array.isArray(g.normal) && g.normal.length > 0;
  });
  return keys.length ? keys : [getSavedGirl()];
}
function refillAllStarBag(){
  const keys = shuffle(getAllStarKeysAvailable());
  allStarBag = keys;
  if(allStarBag.length >= 2 && allStarBag[0] === allStarLastKey){
    [allStarBag[0], allStarBag[1]] = [allStarBag[1], allStarBag[0]];
  }
}
function nextAllStarKey(){
  if(!allStarBag.length) refillAllStarBag();
  const k = allStarBag.shift();
  allStarLastKey = k || "";
  return k || getSavedGirl();
}
function setAllStarEnabled(next){
  allStarEnabled = !!next;
  try{ localStorage.setItem(ALLSTAR_ENABLED_KEY, allStarEnabled ? "1" : "0"); }catch(e){}
}
function toggleAllStarEnabled(){
  if(!allStarUnlocked){
    alert("ã‚ªãƒ¼ãƒ«ã‚¹ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã¯èª²é‡‘ã§è§£æ”¾ã•ã‚Œã¾ã™");
    return;
  }
  setAllStarEnabled(!allStarEnabled);
}
function pickGirlForPlay(){
  if(!allStarEnabled) return getSelectedGirl();
  const k = nextAllStarKey();
  return getGirlByKey(k) || getSelectedGirl();
}
function refreshAllStarUI(){
  if(!btnToggleAllStar) return;
  btnToggleAllStar.textContent = `â­ ã‚ªãƒ¼ãƒ«ã‚¹ã‚¿ãƒ¼ï¼š${allStarEnabled ? "ON" : "OFF"}`;
  if(allStarNote){
    allStarNote.style.display = allStarUnlocked ? "none" : "block";
  }
}

/* ===== 45/25 UI ===== */
function setQuizLengthMode(next){
  quizLengthMode = (next === "25") ? "25" : "45";
  try{ localStorage.setItem(QUIZ_LEN_KEY, quizLengthMode); }catch(e){}
}
function refreshQuizLenUI(){
  if(btnQuizLen) btnQuizLen.textContent = `ğŸ§© å‡ºé¡Œæ•°ï¼š${quizLengthMode}å•`;
  if(quizLenNote) quizLenNote.style.display = quiz25Unlocked ? "none" : "block";
}
function toggleQuizLen(){
  if(quizLengthMode === "45"){
    if(!quiz25Unlocked){
      alert("25å•ãƒ¢ãƒ¼ãƒ‰ã¯èª²é‡‘ã§è§£æ”¾ã•ã‚Œã¾ã™");
      return;
    }
    setQuizLengthMode("25");
  }else{
    setQuizLengthMode("45");
  }
  refreshQuizLenUI();
}

/* ã“ã®ã€Œå•ã€ã§å‡ºã‚‹ã‚­ãƒ£ãƒ©å›ºå®š */
let playGirl = null;
function setPlayGirl(g){ playGirl = g; }
function getPlayGirl(){ return playGirl || getSelectedGirl(); }

/* ui helpers */
function refreshBestLine(){
  bestLine.textContent = `ãƒãƒ¼å¨˜ BESTï¼šã‚¹ãƒ†ãƒ¼ã‚¸${getBestStage()}`;
}
function preloadTops(){
  GIRLS.forEach(g=>{ const im=new Image(); im.src=g.top; });
}
function setGirlAndModeBgToSelectedTop(){
  const g = getSelectedGirl();
  girlBg.style.backgroundImage = `url("${g.top}")`;
  modeBg.style.backgroundImage = `url("${g.top}")`;
}
function setGirlSelectPreviewBg(girlKey){
  const g = getGirlByKey(girlKey);
  previewBgKey = g.key;
  setPreviewKey(g.key);
  girlBg.style.backgroundImage = `url("${g.top}")`;
}

/* audio */
let audioCtx=null;
function ensureAudio(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if(audioCtx.state === "suspended") audioCtx.resume();
}
function playPopSE(){
  try{
    ensureAudio();
    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "sine";
    osc.frequency.setValueAtTime(660, t0);
    osc.frequency.exponentialRampToValueAtTime(880, t0 + 0.03);
    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(0.18, t0 + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.10);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(t0); osc.stop(t0 + 0.11);
  }catch(e){}
}
function flashBg(){
  flashEl.classList.add("on");
  setTimeout(()=> flashEl.classList.remove("on"), FLASH_ON_MS);
}
function playAnnounceSE(){
  try{
    ensureAudio();
    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "sine";
    osc.frequency.setValueAtTime(740, t0);
    osc.frequency.exponentialRampToValueAtTime(1040, t0 + 0.06);
    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(0.22, t0 + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start(t0);
    osc.stop(t0 + 0.20);
  }catch(e){}
}

/* announce */
const ANNOUNCE_SHOW_MS = 1500;
function showCheeAnnounce(){
  locked = true;
  gameScreen.classList.add("announce");
  playAnnounceSE();
  tset(()=>{
    gameScreen.classList.remove("announce");
    locked = false;
  }, ANNOUNCE_SHOW_MS);
}

/* colors */
const buttonColors = [
  "#d64545","#c0392b","#e67e22","#f1c40f",
  "#27ae60","#16a085","#2980b9","#8e44ad",
  "#2c3e50","#7f8c8d","#ff6b6b","#ffa502"
];
function applyRandomColorsToButtons(){
  const btns = document.querySelectorAll("#choices button.choice");
  const cols = shuffle(buttonColors);
  btns.forEach((b,idx)=>{ b.style.background = cols[idx % cols.length]; });
}
function setButtonsEnabled(on){
  document.querySelectorAll("#choices button").forEach(b=>b.disabled=!on);
}

/* speech */
function clearSpeech(){ speechEl.className=""; speechEl.textContent=""; speechEl.innerHTML=""; }
function setSpeechPlain(text){ speechEl.className=""; speechEl.textContent=text; }
function setHeartOnlyPop(isGold=false){
  speechEl.className = isGold ? "heartGold" : "heartOnly";
  speechEl.textContent = "â¤";
  speechEl.classList.remove("heartPop");
  void speechEl.offsetWidth;
  speechEl.classList.add("heartPop");
  playPopSE(); flashBg();
}
function setGyuuWithHeart(){ speechEl.className=""; speechEl.innerHTML = `ã‚®ãƒ¥ã‚¦<span class="heartOnly">â¤</span>`; }
function setTextWithHeart(text){ speechEl.className=""; speechEl.innerHTML = `${text}<span class="heartOnly">â¤</span>`; }

/* gauge */
function stopCheeTimer(){ cancelAnimationFrame(rafId); rafId=0; }
function hideGauge(){ gaugeWrap.classList.remove("show"); gaugeBar.style.transform="scaleX(0)"; }
function showGauge(){ gaugeWrap.classList.add("show"); }
function resetCheeVisuals(){
  clearCheeTimeouts();
  gameScreen.classList.remove("chee","cut","announce","hold","stage3plus","result");
  hideGauge();
  stopCheeTimer();
  gaugeBar.classList.remove("yellow","red");
  choicesEl.classList.remove("chee10");
}

/* choices */
function buildChoices4(){
  choicesEl.classList.remove("chee10");
  choicesEl.innerHTML="";
  const items=[["ã¯ã„"],["ã„ã„ãˆ"],["ãƒãƒ¼"],["ã‚®ãƒ¥ã‚¦"]];
  shuffle(items).forEach(([t])=>{
    const b=document.createElement("button");
    b.textContent=t;
    b.className="choice";
    b.onclick=()=>answer(t);
    choicesEl.appendChild(b);
  });
  applyRandomColorsToButtons();
}
function buildChoicesChee10(){
  const decoys = [
    "ã¯ã„","ã„ã„ãˆ","ãƒãƒ¼","ãƒãƒ³","ã‚«ãƒ³","ãƒ‰ãƒ³","ãƒ¢ãƒ¼","ç‰›","ãƒãƒ¼ã‚º","ç‰¹ç››ã‚Š",
    "ä¸¦","å¤§ç››ã‚Š","æ¹¯æ°—","ãƒ‹ã‚³ãƒƒ","ã‚¯ã‚¹ãƒƒ","ç¬‘","ã†ã—","ãã‚…","ãƒãƒ¼ç‰›","ç‰›ä¸¼"
  ];
  const nine = shuffle(decoys.filter(x=>x!=="ã‚®ãƒ¥ã‚¦")).slice(0, 9);
  let labels = ["ã‚®ãƒ¥ã‚¦", ...nine];

  for(let k=0;k<10;k++){
    labels = shuffle(labels);
    const idx = labels.indexOf("ã‚®ãƒ¥ã‚¦");
    if(idx !== lastGyuuIndex){ lastGyuuIndex = idx; break; }
  }

  choicesEl.classList.add("chee10");
  choicesEl.innerHTML="";
  labels.forEach(label=>{
    const b=document.createElement("button");
    b.textContent = label;
    b.className="choice";
    b.onclick=()=>answer(label);
    choicesEl.appendChild(b);
  });
  applyRandomColorsToButtons();
}

/* screens */
function showOnly(screen){
  [topScreen,girlScreen,modeScreen,gameScreen].forEach(s=>s.classList.add("hide"));
  screen.classList.remove("hide");
}
function goTop(){
  stopCheeTimer();
  resetCheeVisuals();
  hideFlag(); /* â˜… */

  ended=false;
  locked=false;
  cheeCooldown=false;
  mode="quiz";
  gameMode="quiz";
  i=0;
  playQuestions = [];
  playGirl=null;

  cheeStage = 1;
  lastGyuuIndex = -1;
  isNewRecordRun = false;

  counterEl.textContent="-";
  refreshBestLine();
  showOnly(topScreen);
}
function goGirlSelect(){
  refreshBestLine();
  renderGirlGrid();
  if(previewBgKey) setGirlSelectPreviewBg(previewBgKey);
  else setGirlAndModeBgToSelectedTop();
  showOnly(girlScreen);
}
function goModeSelect(){
  refreshBestLine();
  setGirlAndModeBgToSelectedTop();
  refreshAllStarUI();
  refreshQuizLenUI();
  showOnly(modeScreen);
}

/* girl grid */
function attachPreviewHandlers(tile, g){
  tile.addEventListener("pointerdown", ()=>{ setGirlSelectPreviewBg(g.key); }, {passive:true});
  tile.addEventListener("pointerenter", ()=>{ setGirlSelectPreviewBg(g.key); }, {passive:true});
}
function renderGirlGrid(){
  girlGrid.innerHTML = "";
  GIRLS.forEach(g=>{
    const tile = document.createElement("button");
    tile.className = "girlTile"
      + (g.key===selectedGirlKey ? " active" : "")
      + (g.locked ? " locked" : "");
    tile.type = "button";

    attachPreviewHandlers(tile, g);

    tile.onclick = ()=>{
      if(g.locked) return;
      selectedGirlKey = g.key;
      saveGirl(g.key);
      setGirlAndModeBgToSelectedTop();
      renderGirlGrid();
    };

    tile.innerHTML = `
      <div class="iconBox">
        <img src="${g.icon}" alt="${g.name}" onerror="this.style.display='none'">
      </div>
      <div class="girlName">${g.name}</div>
      ${g.locked ? `<div class="lockBadge">LOCK</div>` : ``}
    `;
    girlGrid.appendChild(tile);
  });
}

/* background apply */
function applyGameQuestionBg(){
  const g = getPlayGirl();
  const list = (g.normal && g.normal.length) ? g.normal : getSelectedGirl().normal;
  let bg = g.top || getSelectedGirl().top;
  if(Array.isArray(list) && list.length){
    bg = list[i % list.length];
  }
  gameBg.style.backgroundImage = `url("${bg}")`;
}

/* chee levels */
function pickCheeLevelNormal(){
  const r = Math.random();
  let acc = 0;
  for(const lv of cheeLevelsNormal){
    acc += lv.weight;
    if(r <= acc) return lv;
  }
  return cheeLevelsNormal[0];
}
function cheeOnlyPickStage(){
  let stage = cheeStage;
  if(Math.random() < 0.25) stage = Math.max(1, stage - (Math.random()<0.7 ? 1 : 2));
  const stars = stage <= 1 ? 1 : (stage === 2 ? 2 : 3);
  const base = 2400 - (stage - 1) * 120;
  const timeMs = Math.max(550, Math.round(base));
  const gaugeType = stars === 1 ? "cool" : (stars === 2 ? "yellow" : "red");
  return { stars, timeMs, gauge:gaugeType, stage };
}

/* question */
function showQuestion(){
  if(!Array.isArray(playQuestions) || playQuestions.length === 0){
    playQuestions = makePlayQuestions();
    i = 0;
  }
  ended=false; locked=false; mode="quiz";
  gameScreen.classList.remove("result");
  resultBox.classList.add("hide");
  resetCheeVisuals();

  setPlayGirl(pickGirlForPlay());
  applyGameQuestionBg();

  // â˜…ã“ã“ã§å›½æ——ã‚’ã€Œæ¯å•ã€å‡ºã™ï¼ˆã¾ãšã¯ã“ã‚Œã§ç¢ºèªï¼‰
  showRandomFlag();

  qEl.classList.add("hide");
  qEl.textContent = playQuestions[i].text;
  clearSpeech();

  counterEl.textContent = `${i+1}/${playQuestions.length}`;
  setTimeout(()=> qEl.classList.remove("hide"), QUESTION_SHOW_DELAY);

  if(gameMode==="cheeOnly") buildChoicesChee10();
  else buildChoices4();

  setButtonsEnabled(true);
}

/* chee spawn */
function maybeChee(){
  if(ended) return;
  if(i >= playQuestions.length-1){ endResult(); return; }

  if(!cheeCooldown && Math.random() < CHEE_RATE){
    cheeCooldown=true;
    setButtonsEnabled(false);
    gameScreen.classList.add("hold");
    setTimeout(()=>{
      gameScreen.classList.remove("hold");
      startCheeBattle(pickCheeLevelNormal());
    }, CHEE_PRE_HOLD_MS);
  }else{
    cheeCooldown=false;
    i++;
    if(i < playQuestions.length) showQuestion();
    else endResult();
  }
}

function startCheeBattle(level){
  if(ended) return;

  clearCheeTimeouts();
  resetCheeVisuals();

  mode="chee";
  locked=true;

  clearSpeech();
  speechEl.style.opacity = "0";
  showCheeAnnounce();

  const g = getPlayGirl();
  const list = (g.normal && g.normal.length) ? g.normal : getSelectedGirl().normal;
  const bg = safePick(list, g.top || getSelectedGirl().top);
  gameBg.style.backgroundImage = `url("${bg}")`;

  tset(()=>{
    if(ended) return;
    locked=false;

    gameScreen.classList.add("chee");
    if(level.stars >= 3) gameScreen.classList.add("stage3plus");

    gameScreen.classList.add("cut");
    tset(()=>{
      gameScreen.classList.remove("cut");

      tset(()=>{
        qEl.textContent="";
        qEl.classList.add("hide");
        clearSpeech();

        tset(()=>{
          speechEl.className = "cheeWord" + (level.stars>=3 ? " big" : "");
          speechEl.textContent = "ãƒãƒ¼ï¼";
          speechEl.style.opacity = "1";

          if(gameMode === "cheeOnly") buildChoicesChee10();
          else buildChoices4();

          startCheeTimer(level);
          setButtonsEnabled(true);
        }, CHEE_SILENCE_MS);

      }, POST_CUT_HOLD_MS);

    }, CUT_MS);

  }, ANNOUNCE_SHOW_MS);
}

function startCheeTimer(level){
  stopCheeTimer();
  showGauge();

  gaugeBar.classList.remove("yellow","red");
  if(level.gauge === "yellow") gaugeBar.classList.add("yellow");
  if(level.gauge === "red") gaugeBar.classList.add("red");

  const start=performance.now();

  const tick=(t)=>{
    let elapsed = t - start;

    if(level.stars >= 3 && elapsed < STAGE3_BOOST_MS){
      elapsed = elapsed * STAGE3_BOOST_MULT;
    }else if(level.stars >= 3 && elapsed >= STAGE3_BOOST_MS){
      const boosted = STAGE3_BOOST_MS * STAGE3_BOOST_MULT;
      elapsed = boosted + (elapsed - STAGE3_BOOST_MS);
    }

    const r = Math.max(0, 1 - (elapsed / level.timeMs));
    gaugeBar.style.transform = `scaleX(${r})`;

    if(level.gauge === "cool"){
      gaugeBar.style.background = `hsl(${210 * r}, 85%, 55%)`;
    }

    if(r > 0){
      rafId = requestAnimationFrame(tick);
    }else{
      gameOver(true);
    }
  };

  rafId = requestAnimationFrame(tick);
}

function nextCheeOnlyAfterWin(){
  cheeStage++;
  counterEl.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¸${cheeStage}`;

  const best = getBestStage();
  if(cheeStage > best){
    setBestStage(cheeStage);
    isNewRecordRun = true;
  }

  if(allStarEnabled){
    setPlayGirl(pickGirlForPlay());
  }

  startCheeBattle(cheeOnlyPickStage());
}

/* answer */
function answer(t){
  if(locked || ended) return;
  locked=true;
  setButtonsEnabled(false);

  ensureAudio();
  qEl.classList.add("hide");

  if(mode==="chee"){
    if(t==="ã‚®ãƒ¥ã‚¦"){
      stopCheeTimer();
      hideGauge();

      setTimeout(()=> setHeartOnlyPop(isNewRecordRun), GIRL_REPLY_DELAY_MS);

      setTimeout(()=>{
        resetCheeVisuals();
        if(gameMode === "cheeOnly"){
          nextCheeOnlyAfterWin();
          return;
        }
        i++;
        if(i < playQuestions.length) showQuestion();
        else endResult();
      }, GIRL_REPLY_DELAY_MS + CHEE_SUCCESS_HOLD_MS);

    }else{
      gameOver(true);
    }
    return;
  }

  const isLast = (i === playQuestions.length - 1);

  setTimeout(()=>{
    const g = getPlayGirl();
    if(t==="ã¯ã„")        setTextWithHeart(g.replies.yes);
    else if(t==="ã„ã„ãˆ") setTextWithHeart(g.replies.no);
    else if(t==="ã‚®ãƒ¥ã‚¦") setTextWithHeart(g.replies.gyuu);
    else if(t==="ãƒãƒ¼")   setGyuuWithHeart();
    else                  setTextWithHeart(g.replies.yes);
  }, GIRL_REPLY_DELAY_MS);

  setTimeout(()=>{
    if(isLast){
      if(t !== "ã‚®ãƒ¥ã‚¦"){ gameOver(false); return; }
      endResult(); return;
    }
    maybeChee();
  }, GIRL_REPLY_DELAY_MS + NORMAL_REACT_MS);
}

/* end buttons */
function renderEndButtonsDelayed(delayMs){
  choicesEl.innerHTML = "";
  setTimeout(()=>{
    choicesEl.innerHTML = `
      <button class="choice" style="grid-column:1/-1" onclick="restart(gameMode)">ã‚‚ã†ä¸€å›</button>
      <button class="choice" style="grid-column:1/-1" onclick="goTop()">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
    `;
    applyRandomColorsToButtons();
  }, delayMs);
}

/* CHIGYUTED ENDING (score=100) */
let giftedMode = false;
let giftedStep = 0;
let giftedGirl = null;

function getGiftedScript(g){
  return [
    { q: "â€¦â€¦ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã€‚", a: ["ã¯ã„","ã„ã„ãˆ","ãƒãƒ¼","ã‚®ãƒ¥ã‚¦"] },
    { q: "ä»Šã€100%å‡ºãŸã£ã¦â€¦ã‚ã‹ã£ã¦ã‚‹ï¼Ÿ", a: ["ã¯ã„","ã„ã„ãˆ","ãƒãƒ¼","ã‚®ãƒ¥ã‚¦"] },
    { q: "ä¸€å¿œç¢ºèªã€‚ãƒãƒ¼ã¨è¨€ãˆã°ï¼Ÿ", a: ["ã¯ã„","ã„ã„ãˆ","ãƒãƒ¼","ã‚®ãƒ¥ã‚¦"], correct:"ã‚®ãƒ¥ã‚¦" },
    { q: "â€¦â€¦ã†ã‚“ã€‚ã‚ãªãŸã¯", a: ["ã¯ã„","ã„ã„ãˆ","ãƒãƒ¼","ã‚®ãƒ¥ã‚¦"] },
    { q: "ãƒãƒ¼ç‰›ã‚®ãƒ•ãƒ†ãƒƒãƒ‰ï¼ˆãƒã‚®ãƒ¥ãƒ†ãƒƒãƒ‰ï¼‰ã ã‚ˆâ¤", a: ["ã¯ã„","ã„ã„ãˆ","ãƒãƒ¼","ã‚®ãƒ¥ã‚¦"] }
  ];
}
function renderGiftedChoices(labels){
  choicesEl.classList.remove("chee10");
  choicesEl.innerHTML = "";
  labels.forEach(label=>{
    const b = document.createElement("button");
    b.textContent = label;
    b.className = "choice";
    b.onclick = ()=> giftedAnswer(label);
    choicesEl.appendChild(b);
  });
  applyRandomColorsToButtons();
  setButtonsEnabled(true);
}
function startGiftedEnding(g){
  giftedMode = true;
  giftedStep = 0;
  giftedGirl = g;
  setButtonsEnabled(true);

  const script = getGiftedScript(giftedGirl);
  clearSpeech();
  setTextWithHeart(script[0].q);
  renderGiftedChoices(script[0].a);
}
function giftedAnswer(t){
  if(!giftedMode) return;

  const script = getGiftedScript(giftedGirl);
  const cur = script[giftedStep];

  if(cur && cur.correct && t !== cur.correct){
    clearSpeech();
    setSpeechPlain("â€¦â€¦");
    setTimeout(()=>{
      clearSpeech();
      setTextWithHeart(cur.q);
    }, 450);
    return;
  }

  giftedStep++;
  if(giftedStep >= script.length){
    giftedMode = false;
    renderEndButtonsDelayed(0);
    return;
  }

  const next = script[giftedStep];
  clearSpeech();
  setTextWithHeart(next.q);
  renderGiftedChoices(next.a);
}

/* result */
function animatePercent(to){
  const dur = 900;
  const start = performance.now();
  const from = 0;

  const tick = (t)=>{
    const p = Math.min(1, (t-start)/dur);
    const eased = 1 - Math.pow(1-p, 3);
    const v = Math.round(from + (to-from)*eased);
    resultPct.innerHTML = `${Math.min(100,v)}<small>%</small>`;
    if(p < 1) requestAnimationFrame(tick);
  };
  requestAnimationFrame(tick);
}

function endResult(){
  ended=true;
  mode="result";
  resetCheeVisuals();

  // RESULTã§ã‚‚å›½æ——ã¯è¡¨ç¤ºã—ãŸã¾ã¾ã§ã‚‚OKï¼ˆå«Œãªã‚‰ hideFlag() ã«ï¼‰
  // hideFlag();

  gameScreen.classList.add("result");
  resultBox.classList.remove("hide");

  const g = getSelectedGirl();

  const score = rollScore();
  const key = scoreToKey(score);
  let img = (g.score && g.score[key]) ? g.score[key] : g.top;
  const line = (g.scoreText && g.scoreText[key]) ? g.scoreText[key] : "";

  if(line && score !== 100){
    setTimeout(()=> setTextWithHeart(line), 520);
  }

  gameBg.style.backgroundImage = `url("${img}")`;

  qEl.textContent="";
  clearSpeech();
  speechEl.style.opacity = "1";
  counterEl.textContent = "RESULT";

  resultPct.innerHTML = `0<small>%</small>`;
  animatePercent(score);

  if(score === 100){
    startGiftedEnding(g);
  }else{
    renderEndButtonsDelayed(0);
  }
}

/* game over */
function gameOver(isCheeBattle){
  ended=true;
  resetCheeVisuals();
  // GAME OVERã§ã‚‚æ——ã¯æ®‹ã™/æ¶ˆã™ã¯å¥½ã¿ã€‚æ¶ˆã™ãªã‚‰â†“
  // hideFlag();

  gameScreen.classList.remove("result");
  resultBox.classList.add("hide");

  const g = getSelectedGirl();

  if(gameMode === "cheeOnly"){
    const reachedStage = cheeStage;
    const bestStage = getBestStage();

    if(reachedStage > bestStage){
      setBestStage(reachedStage);
      isNewRecordRun = true;
    }

    if(g.chiGameover) gameBg.style.backgroundImage = `url("${g.chiGameover}")`;
    clearSpeech();
    setSpeechPlain(g.chiOverText || "â€¦â€¦");

    counterEl.textContent = `GAME OVERï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸${reachedStage}ï¼‰`;
    renderEndButtonsDelayed(1000);
    return;
  }

  if(g.gameover) gameBg.style.backgroundImage = `url("${g.gameover}")`;
  clearSpeech();
  setSpeechPlain("ã‚ãªãŸãƒãƒ¼ç‰›ã˜ã‚ƒãªã‹ã£ãŸã®ã­ã€‚ã€‚");
  counterEl.textContent = "GAME OVER";
  renderEndButtonsDelayed(1000);
}

/* restart */
function restart(modeName){
  ended=false;
  cheeCooldown=false;
  mode="quiz";
  locked=false;
  stopCheeTimer();
  resetCheeVisuals();

  gameMode = modeName || "quiz";
  isNewRecordRun = false;
  playGirl = null;

  gameScreen.classList.remove("result");
  resultBox.classList.add("hide");

  showOnly(gameScreen);

  if(gameMode === "cheeOnly") playQuestions = [];

  if(gameMode === "cheeOnly"){
    cheeStage = 1;
    lastGyuuIndex = -1;
    counterEl.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¸${cheeStage}`;
    setPlayGirl(pickGirlForPlay());
    // ãƒãƒ¼å¨˜ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚æ——è¡¨ç¤ºï¼ˆå«Œãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    showRandomFlag();
    startCheeBattle(cheeOnlyPickStage());
  }else{
    i=0;
    playQuestions = makePlayQuestions();
    showQuestion();
  }
}

/* init bindings */
document.getElementById("btnGoGirl").onclick = ()=>{ goGirlSelect(); };
document.getElementById("btnGirlBack").onclick = ()=>{ goTop(); };
document.getElementById("btnGoMode").onclick = ()=>{ goModeSelect(); };
document.getElementById("btnModeBack").onclick = ()=>{ goGirlSelect(); };

document.getElementById("btnStartQuiz").onclick = ()=>{ restart("quiz"); };
document.getElementById("btnStartChee").onclick = ()=>{ restart("cheeOnly"); };

if(btnToggleAllStar){
  btnToggleAllStar.onclick = ()=>{
    toggleAllStarEnabled();
    refreshAllStarUI();
  };
}
if(btnQuizLen){
  btnQuizLen.onclick = ()=> toggleQuizLen();
}

function init(){
  selectedGirlKey = getSavedGirl();
  preloadTops();
  refreshBestLine();
  setGirlAndModeBgToSelectedTop();

  const pk = getPreviewKey();
  if(pk) previewBgKey = pk;

  try{ allStarEnabled = localStorage.getItem(ALLSTAR_ENABLED_KEY) === "1"; }catch(e){}
  try{
    const v = localStorage.getItem(QUIZ_LEN_KEY);
    if(v==="25" || v==="45") quizLengthMode = v;
  }catch(e){}
  try{
    if(localStorage.getItem(QUIZ25_UNLOCK_KEY) === "1") quiz25Unlocked = true;
  }catch(e){}

  refreshAllStarUI();
  refreshQuizLenUI();
}

init();
goTop();
</script>
</body>
</html>
